# Deployment Guide for Student Management System

This guide covers how to deploy the Student Management System backend to Render using Docker.

## Prerequisites

- [Docker Desktop](https://www.docker.com/products/docker-desktop) installed (for local testing)
- [Render account](https://render.com) (free tier available)
- MySQL database (options below)
- Git repository with your code

## Database Setup Options

### Option 1: Use Railway MySQL (Recommended for Free Tier)
1. Sign up at [Railway](https://railway.app)
2. Create a new project and add MySQL
3. Copy the connection details (host, port, user, password, database)

### Option 2: Use PlanetScale MySQL
1. Sign up at [PlanetScale](https://planetscale.com)
2. Create a new database
3. Get connection string from dashboard

### Option 3: Use AWS RDS MySQL
1. Create MySQL instance in AWS RDS
2. Configure security groups to allow Render IP addresses
3. Get connection details

## Local Testing with Docker

### Step 1: Test with Docker Compose (Recommended)

This will run both the application and MySQL database locally:

```bash
# Navigate to project directory
cd c:\Users\SivaSuriyan\OneDrive\Desktop\Studentt\StudentLoginBackend

# Build and start all services
docker-compose up --build

# The application will be available at http://localhost:8081
```

To stop the services:
```bash
docker-compose down
```

To stop and remove all data:
```bash
docker-compose down -v
```

### Step 2: Test Docker Image Alone

If you have an external MySQL database:

```bash
# Build the Docker image
docker build -t student-management-backend:latest .

# Run the container (replace with your database credentials)
docker run -p 8081:8081 \
  -e SPRING_DATASOURCE_URL="jdbc:mysql://YOUR_DB_HOST:3306/student_db?useSSL=true&serverTimezone=UTC" \
  -e SPRING_DATASOURCE_USERNAME="your_username" \
  -e SPRING_DATASOURCE_PASSWORD="your_password" \
  -e JWT_SECRET="your-super-secret-jwt-key-minimum-256-bits" \
  student-management-backend:latest
```

### Step 3: Verify Health

```bash
# Check health endpoint
curl http://localhost:8081/actuator/health

# Expected response:
# {"status":"UP"}
```

## Deploying to Render

### Method 1: Using Render Blueprint (Automated)

1. **Push your code to GitHub**
   ```bash
   git add .
   git commit -m "Add Docker configuration"
   git push origin main
   ```

2. **Connect to Render**
   - Go to [Render Dashboard](https://dashboard.render.com)
   - Click "New +" → "Blueprint"
   - Connect your GitHub repository
   - Render will detect `render.yaml` and set up the service automatically

3. **Configure Environment Variables**
   
   After deployment is created, go to the service settings and add:
   
   | Variable Name | Value | Example |
   |---------------|-------|---------|
   | `SPRING_DATASOURCE_URL` | Your MySQL connection URL | `jdbc:mysql://containers-us-west-123.railway.app:6789/railway?useSSL=true` |
   | `SPRING_DATASOURCE_USERNAME` | Database username | `root` |
   | `SPRING_DATASOURCE_PASSWORD` | Database password | `***` |
   | `JWT_SECRET` | Random 256-bit secret | Auto-generated by Render |
   
   > **Note**: The `JWT_SECRET` should be auto-generated by Render. If not, generate one using:
   > ```bash
   > openssl rand -base64 64
   > ```

4. **Deploy**
   - Click "Apply" or trigger a manual deploy
   - Wait for build to complete (5-10 minutes)
   - Once deployed, your service URL will be: `https://student-management-backend.onrender.com`

### Method 2: Manual Deployment

1. **Create a New Web Service**
   - Go to [Render Dashboard](https://dashboard.render.com)
   - Click "New +" → "Web Service"
   - Connect your GitHub repository
   - Select your repository and branch

2. **Configure the Service**
   
   | Setting | Value |
   |---------|-------|
   | Name | `student-management-backend` |
   | Environment | `Docker` |
   | Region | Choose closest to your users |
   | Branch | `main` |
   | Dockerfile Path | `./Dockerfile` |
   | Instance Type | `Free` (or paid plan) |

3. **Add Environment Variables** (same as Method 1)

4. **Deploy**
   - Click "Create Web Service"
   - Render will build and deploy automatically

## Post-Deployment

### 1. Verify Deployment

Once deployed, test your endpoints:

```bash
# Replace with your actual Render URL
curl https://student-management-backend.onrender.com/actuator/health

# Test login endpoint
curl -X POST https://student-management-backend.onrender.com/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin"}'
```

### 2. Configure Frontend

Update your frontend to use the Render backend URL:

```javascript
// In your frontend configuration
const API_BASE_URL = 'https://student-management-backend.onrender.com';
```

### 3. Monitor Logs

- Go to your service in Render Dashboard
- Click "Logs" tab to view application logs
- Monitor for any errors or issues

## Important Notes

### Free Tier Limitations

> [!WARNING]
> Render's free tier services will **spin down after 15 minutes of inactivity**. The first request after inactivity may take 30-60 seconds to respond.

> [!TIP]
> To prevent spin-down, upgrade to a paid plan ($7/month as of 2026) or use a service like [UptimeRobot](https://uptimerobot.com) to ping your service every 14 minutes.

### Database Connection

> [!IMPORTANT]
> Make sure your MySQL database:
> - Allows connections from Render's IP addresses
> - Has SSL enabled if required
> - Is accessible from the internet

### Security Best Practices

> [!CAUTION]
> - **Never commit** database credentials or JWT secrets to Git
> - Use Render's environment variables for all sensitive data
> - Generate a strong JWT secret (minimum 256 bits)
> - In production, set `SPRING_JPA_DDL_AUTO=validate` to prevent schema changes

## Troubleshooting

### Build Fails

**Problem**: Docker build fails during Maven build

**Solution**: 
- Check Maven errors in build logs
- Ensure `pom.xml` is valid
- Verify Java version compatibility (Java 17)

### Application Crashes on Startup

**Problem**: Service starts but crashes immediately

**Solution**:
1. Check logs for errors
2. Verify database connection string is correct
3. Ensure database is reachable from Render
4. Check if all required environment variables are set

### Database Connection Timeout

**Problem**: `Communications link failure` or connection timeout

**Solution**:
- Verify database host and port are correct
- Check if database allows external connections
- Ensure SSL settings match your database requirements
- Add `?allowPublicKeyRetrieval=true` to connection URL

### Health Check Failing

**Problem**: Render shows "Service unhealthy"

**Solution**:
- Verify `/actuator/health` endpoint is accessible
- Check if database connection is working
- Increase health check timeout in Render settings

## Environment Variables Reference

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `PORT` | No | 8081 | Port the application listens on (Render sets this automatically) |
| `SPRING_DATASOURCE_URL` | Yes | - | MySQL JDBC connection URL |
| `SPRING_DATASOURCE_USERNAME` | Yes | - | Database username |
| `SPRING_DATASOURCE_PASSWORD` | Yes | - | Database password |
| `JWT_SECRET` | Yes | - | Secret key for JWT token signing (256+ bits) |
| `JWT_EXPIRATION` | No | 86400000 | JWT token expiration in milliseconds (24 hours) |
| `SPRING_JPA_DDL_AUTO` | No | update | Hibernate DDL auto mode (validate/update/create) |
| `SPRING_JPA_SHOW_SQL` | No | false | Show SQL queries in logs |

## Updating Your Application

When you push changes to your GitHub repository:

1. Render will automatically detect the changes (if auto-deploy is enabled)
2. Build a new Docker image
3. Deploy the new version with zero-downtime rolling update

To manually trigger a deploy:
- Go to your service in Render Dashboard
- Click "Manual Deploy" → "Deploy latest commit"

## Cost Estimation

- **Free Tier**: $0/month (with limitations)
  - 750 hours/month free
  - Service spins down after 15 minutes inactivity
  - Limited resources

- **Starter Plan**: ~$7/month
  - Always-on service
  - More resources
  - Better for production

- **Database Costs** (external):
  - Railway: ~$5-10/month
  - PlanetScale: Free tier available, $29/month for production
  - AWS RDS: ~$15-30/month (t3.micro)

## Support

For issues specific to:
- **Render**: [Render Documentation](https://render.com/docs)
- **Docker**: [Docker Documentation](https://docs.docker.com)
- **Spring Boot**: [Spring Boot Documentation](https://docs.spring.io/spring-boot/docs/current/reference/html/)

## Next Steps

1. ✅ Verify local Docker build works
2. ✅ Set up external MySQL database
3. ✅ Deploy to Render
4. ✅ Configure environment variables
5. ✅ Test all endpoints
6. ✅ Update frontend to use Render URL
7. ✅ Monitor logs and performance
